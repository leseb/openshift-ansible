---
<<<<<<< HEAD
<<<<<<< HEAD
=======
# TODO: Enhance redhat_subscription module
#       to make it able to attach to a pool
#       to make it able to enable repositories
=======
- set_fact:
    rhel_subscription_pass: "{{ lookup('env', 'rhel_subscription_pass') | default(rhsub_pass | default(omit, True)) }}"
    rhel_subscription_pool: "{{ lookup('env', 'rhel_subscription_pool') | default(rhsub_pool | default('Red Hat OpenShift Container Platform, Premium*')) }}"
    rhel_subscription_user: "{{ lookup('env', 'rhel_subscription_user') | default(rhsub_user | default(omit, True)) }}"
    rhel_subscription_server: "{{ lookup('env', 'rhel_subscription_server') | default(rhsub_server | default(omit, True)) }}"
>>>>>>> Commit to stabalize RHSM operations.  This code is derived from contrib

<<<<<<< HEAD
- set_fact:
    rhel_subscription_pool: "{{ lookup('env', 'rhel_subscription_pool') | default(rhsub_pool | default('Red Hat OpenShift Container Platform, Premium*')) }}"
    rhel_subscription_user: "{{ lookup('env', 'rhel_subscription_user') | default(rhsub_user | default(omit, True)) }}"
    rhel_subscription_pass: "{{ lookup('env', 'rhel_subscription_pass') | default(rhsub_pass | default(omit, True)) }}"
    rhel_subscription_server: "{{ lookup('env', 'rhel_subscription_server') | default(rhsub_server | default(omit, True)) }}"

=======
>>>>>>> Remove reading shell environment in rhel_subscribe
>>>>>>> Remove reading shell environment in rhel_subscribe
- fail:
    msg: "This role is only supported for Red Hat hosts"
  when: ansible_distribution != 'RedHat'

<<<<<<< HEAD
=======
- fail:
    msg: The rhel_subscription_user variable is required for this role.
  when: rhel_subscription_user is not defined or not rhsub_user is not defined

- fail:
    msg: The rhel_subscription_pass variable is required for this role.
  when: rhel_subscription_pass is not defined or not rhsub_pass is not defined

>>>>>>> Remove reading shell environment in rhel_subscribe
- name: Install Red Hat Subscription manager
  yum:
    name: subscription-manager
    state: present
  register: result
<<<<<<< HEAD
  until: result is succeeded

- name: Is host already registered?
  command: "subscription-manager version"
  register: rh_subscribed
  changed_when: False
=======
  until: result | success
>>>>>>> retry package operations

<<<<<<< HEAD
- name: Register host using user/password
=======
- name: Is host already registered?
  command: bash -c "subscription-manager version"
  register: rh_subscribed
  changed_when: "'not registered' in rh_subscribed.stdout"
  ignore_errors: yes

- name: Register host
>>>>>>> Commit to stabalize RHSM operations.  This code is derived from contrib
  redhat_subscription:
    username: "{{ rhel_subscription_user }}"
    password: "{{ rhel_subscription_pass }}"
  register: rh_subscription
<<<<<<< HEAD
  until: rh_subscription is succeeded
  when:
    - "'not registered' in rh_subscribed.stdout"
    - rhsub_user is defined
    - rhsub_pass is defined

<<<<<<< HEAD
- name: Register host using activation key
  redhat_subscription:
    activationkey: "{{ rhsub_ak }}"
    org_id: "{{ rhsub_orgid }}"
  register: rh_subscription
  until: rh_subscription is succeeded
  when:
    - "'not registered' in rh_subscribed.stdout"
    - rhsub_ak is defined
    - rhsub_orgid is defined

- name: Determine if OpenShift Pool Already Attached
  command: "subscription-manager list --consumed --pool-only --matches '*OpenShift*'"
=======
- name: Retrieve the OpenShift Pool ID
  command: subscription-manager list --available --matches="{{ rhsub_pool }}" --pool-only
  register: openshift_pool_id
  until: openshift_pool_id | succeeded
  changed_when: False

- name: Determine if OpenShift Pool Already Attached
  command: subscription-manager list --consumed --matches="{{ rhsub_pool }}" --pool-only
>>>>>>> Remove reading shell environment in rhel_subscribe
  register: openshift_pool_attached
  changed_when: False
<<<<<<< HEAD
  ignore_errors: yes
=======
  when: openshift_pool_id.stdout == ''

- fail:
    msg: "Unable to find pool matching {{ rhsub_pool }} in available or consumed pools"
  when: openshift_pool_id.stdout == '' and openshift_pool_attached is defined and openshift_pool_attached.stdout == ''
>>>>>>> Remove reading shell environment in rhel_subscribe

- name: Attach to OpenShift Pool
  command: "subscription-manager attach --pool {{ rhsub_pool }}"
  register: openshift_pool_attached
  changed_when: "'Successfully attached a subscription' in openshift_pool_attached.stdout"
  when: rhsub_pool not in openshift_pool_attached.stdout

<<<<<<< HEAD
- import_tasks: satellite.yml
=======
- include_tasks: enterprise.yml
>>>>>>> Include Deprecation: Convert to include_tasks
  when:
    - rhsub_server is defined
    - rhsub_server
=======
  until: rh_subscription | succeeded
  when:
    - "'not registered' in rh_subscribed.stdout"
    - rhel_subscription_user is defined
    - rhel_subscription_pass is defined

- fail:
    msg: 'Unable to register host with Red Hat Subscription Manager'
  when:
    - "'not registered' in rh_subscribed.stdout"
    - rh_subscription.failed

- name: Determine if OpenShift Pool Already Attached
  command: bash -c "subscription-manager list --consumed --pool-only --matches '*OpenShift*' | grep {{ rhel_subscription_pool }}"
  register: openshift_pool_attached
  changed_when: rhel_subscription_pool not in openshift_pool_attached.stdout
  failed_when: openshift_pool_attached.rc == 2
  ignore_errors: yes

- name: Retrieve the OpenShift Pool ID
  command: bash -c "subscription-manager list --available --pool-only --matches '*OpenShift*' | grep {{ rhel_subscription_pool }}"
  register: openshift_pool_retrieve
  changed_when: rhel_subscription_pool in openshift_pool_retrieve.stdout
  when: rhel_subscription_pool not in openshift_pool_attached.stdout
  ignore_errors: yes

- fail:
    msg: "Unable to find pool matching {{ rhel_subscription_pool }} in available pools"
  when:
    - rhel_subscription_pool not in openshift_pool_attached.stdout
    - rhel_subscription_pool not in openshift_pool_retrieve.stdout

- name: Attach to OpenShift Pool
  command: bash -c "subscription-manager attach --pool {{ rhel_subscription_pool }}"
  register: openshift_pool_attached
  changed_when: "'Successfully attached a subscription' in openshift_pool_attached.stdout"
  when: rhel_subscription_pool not in openshift_pool_attached.stdout

- include_role:
    role: rhel_subscribe
    tasks_from: satellite
  when:
    - (rhel_subscription_server or rhsub_server) is defined
    - (rhel_subscription_server or rhsub_server)
>>>>>>> Commit to stabalize RHSM operations.  This code is derived from contrib
